<% layout("layouts/boilerplate") %>

    <!-- Dashboard Page -->
    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="fw-bold mb-2">Financial Dashboard</h1>
                <p class="text-muted">Track your income, expenses, and savings in real-time</p>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row g-4 mb-4">
            <div class="col-md-6 col-lg-3">
                <div class="summary-card">
                    <div class="card-icon income-icon">
                        <i class="fas fa-arrow-up"></i>
                    </div>
                    <div>
                        <p class="card-label">Monthly Income</p>
                        <h3 class="card-value" id="totalIncome">₹56,000</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="summary-card">
                    <div class="card-icon expense-icon">
                        <i class="fas fa-arrow-down"></i>
                    </div>
                    <div>
                        <p class="card-label">This Month Expense</p>
                        <h3 class="card-value" id="currentExpense">₹0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="summary-card">
                    <div class="card-icon saving-icon">
                        <i class="fas fa-piggy-bank"></i>
                    </div>
                    <div>
                        <p class="card-label">Current Savings</p>
                        <h3 class="card-value" id="currentSaving">₹0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="summary-card">
                    <div class="card-icon rate-icon">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div>
                        <p class="card-label">Savings Rate</p>
                        <h3 class="card-value" id="savingsRate">0%</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Graph Row 1 -->
        <div class="row g-4 mb-4">
            <div class="col-lg-8">
                <div class="chart-card">
                    <div class="chart-header">
                        <h5 class="fw-bold mb-0">Income vs Expense</h5>
                        <select id="yearSelect" class="form-select form-select-sm w-auto">
                            <option value="2024">2024</option>
                            <option value="2025" selected>2025</option>
                            <option value="2026">2026</option>
                        </select>
                    </div>
                    <canvas id="incomeExpenseChart"></canvas>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="chart-card">
                    <div class="chart-header">
                        <h5 class="fw-bold mb-0">Expense Categories</h5>
                    </div>
                    <canvas id="categoryPieChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Graph Row 2 -->
        <div class="row g-4 mb-4">
            <div class="col-lg-6">
                <div class="chart-card">
                    <div class="chart-header">
                        <h5 class="fw-bold mb-0">Daily Expenses</h5>
                        <select id="monthSelect" class="form-select form-select-sm w-auto">
                            <option value="0">January</option>
                            <option value="1">February</option>
                            <option value="2">March</option>
                            <option value="3">April</option>
                            <option value="4">May</option>
                            <option value="5">June</option>
                            <option value="6">July</option>
                            <option value="7">August</option>
                            <option value="8">September</option>
                            <option value="9">October</option>
                            <option value="10">November</option>
                            <option value="11">December</option>
                        </select>
                    </div>
                    <canvas id="dailyExpenseChart"></canvas>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-card">
                    <div class="chart-header">
                        <h5 class="fw-bold mb-0">Expense vs Savings</h5>
                    </div>
                    <canvas id="expenseSavingsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Graph Row 3 -->
        <div class="row g-4 mb-4">
            <div class="col-12">
                <div class="chart-card">
                    <div class="chart-header">
                        <h5 class="fw-bold mb-0">Monthly Cash Flow</h5>
                        <p class="text-muted small mb-0">Percentage of income saved each month</p>
                    </div>
                    <canvas id="cashFlowChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Data from backend
        const monthlyIncome = <%- JSON.stringify(chartData.monthlyIncome) %>;
        const monthlyExpenses = <%- JSON.stringify(chartData.monthlyExpense) %>;
        const allMonthExpenses = <%- JSON.stringify(chartData.allMonthDailyExpenses) %>;
        const categoryData = <%- JSON.stringify(chartData.categoryData) %>;

        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

        // Calculate monthly income (use first non-zero value or average)
        const avgMonthlyIncome = monthlyIncome.reduce((a, b) => a + b, 0) / 12;

        // Calculate savings
        const monthlySavings = monthlyIncome.map((income, idx) => income - monthlyExpenses[idx]);

        // Update summary cards
        function updateSummaryCards() {
            document.getElementById('totalIncome').textContent = '₹' + <%= stats.income.toLocaleString() %>;
            document.getElementById('currentExpense').textContent = '₹' + <%= stats.expense.toLocaleString() %>;
            document.getElementById('currentSaving').textContent = '₹' + <%= stats.saving.toLocaleString() %>;
            document.getElementById('savingsRate').textContent = '<%= stats.rate %>%';
        }

        // Chart configurations
        const chartConfig = {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'top',
                }
            }
        };

        // 1. Income vs Expense Chart
        const incomeExpenseChart = new Chart(document.getElementById('incomeExpenseChart'), {
            type: 'bar',
            data: {
                labels: months,
                datasets: [
                    {
                        label: 'Income',
                        data: monthlyIncome,
                        backgroundColor: 'rgba(45, 206, 137, 0.8)',
                        borderColor: 'rgba(45, 206, 137, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Expense',
                        data: monthlyExpenses,
                        backgroundColor: 'rgba(251, 99, 64, 0.8)',
                        borderColor: 'rgba(251, 99, 64, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                ...chartConfig,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // 2. Category Pie Chart
        const categoryLabels = Object.keys(categoryData).filter(key => categoryData[key] > 0);
        const categoryValues = categoryLabels.map(key => categoryData[key]);

        const categoryPieChart = new Chart(document.getElementById('categoryPieChart'), {
            type: 'doughnut',
            data: {
                labels: categoryLabels.length > 0 ? categoryLabels : ['No Data'],
                datasets: [{
                    data: categoryValues.length > 0 ? categoryValues : [1],
                    backgroundColor: [
                        'rgba(94, 114, 228, 0.8)',
                        'rgba(251, 99, 64, 0.8)',
                        'rgba(240, 147, 251, 0.8)',
                        'rgba(45, 206, 137, 0.8)',
                        'rgba(255, 193, 7, 0.8)',
                        'rgba(16, 213, 194, 0.8)',
                        'rgba(245, 87, 108, 0.8)',
                        'rgba(79, 172, 254, 0.8)',
                        'rgba(255, 152, 0, 0.8)'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                ...chartConfig,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // 3. Daily Expense Chart
        let dailyExpenseChart = new Chart(document.getElementById('dailyExpenseChart'), {
            type: 'bar',
            data: {
                labels: Array.from({ length: 30 }, (_, i) => i + 1),
                datasets: [{
                    label: 'Daily Expense',
                    data: allMonthExpenses[0],
                    backgroundColor: 'rgba(255, 152, 0, 0.8)',
                    borderColor: 'rgba(255, 152, 0, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                ...chartConfig,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // 4. Expense vs Savings Line Chart
        const expenseSavingsChart = new Chart(document.getElementById('expenseSavingsChart'), {
            type: 'line',
            data: {
                labels: months,
                datasets: [
                    {
                        label: 'Total Expense',
                        data: monthlyExpenses,
                        borderColor: 'rgba(251, 99, 64, 1)',
                        backgroundColor: 'rgba(251, 99, 64, 0.2)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Savings',
                        data: monthlySavings,
                        borderColor: 'rgba(45, 206, 137, 1)',
                        backgroundColor: 'rgba(45, 206, 137, 0.2)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                ...chartConfig,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // 5. Cash Flow Pie Chart
        const cashFlowPercentages = monthlySavings.map((saving, idx) => {
            const income = monthlyIncome[idx];
            return income > 0 ? ((saving / income) * 100).toFixed(1) : 0;
        });
        const cashFlowChart = new Chart(document.getElementById('cashFlowChart'), {
            type: 'pie',
            data: {
                labels: months,
                datasets: [{
                    data: cashFlowPercentages,
                    backgroundColor: [
                        'rgba(94, 114, 228, 0.8)',
                        'rgba(130, 94, 228, 0.8)',
                        'rgba(251, 99, 64, 0.8)',
                        'rgba(251, 177, 64, 0.8)',
                        'rgba(45, 206, 137, 0.8)',
                        'rgba(16, 213, 194, 0.8)',
                        'rgba(240, 147, 251, 0.8)',
                        'rgba(245, 87, 108, 0.8)',
                        'rgba(79, 172, 254, 0.8)',
                        'rgba(0, 242, 254, 0.8)',
                        'rgba(255, 193, 7, 0.8)',
                        'rgba(255, 152, 0, 0.8)'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                ...chartConfig,
                plugins: {
                    legend: {
                        position: 'right'
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return context.label + ': ' + context.parsed + '% saved';
                            }
                        }
                    }
                }
            }
        });

        // Event Listeners for dynamic updates
        document.getElementById('monthSelect').addEventListener('change', function (e) {
            const monthIndex = parseInt(e.target.value);
            dailyExpenseChart.data.datasets[0].data = allMonthExpenses[monthIndex];
            dailyExpenseChart.update();
        });

        document.getElementById('yearSelect').addEventListener('change', function (e) {
            // In real app, fetch data for selected year
            console.log('Year changed to:', e.target.value);
        });

        // Initialize
        updateSummaryCards();

        // Update function for real-time data changes
        function updateDashboardData(newExpenseData) {
            // Update all charts with new data
            const newMonthlyExpenses = newExpenseData.map(days => days.reduce((a, b) => a + b, 0));
            const newMonthlySavings = monthlyIncome.map((income, idx) => income - newMonthlyExpenses[idx]);

            incomeExpenseChart.data.datasets[1].data = newMonthlyExpenses;
            incomeExpenseChart.update();

            expenseSavingsChart.data.datasets[0].data = newMonthlyExpenses;
            expenseSavingsChart.data.datasets[1].data = newMonthlySavings;
            expenseSavingsChart.update();

            const newCashFlowPercentages = newMonthlySavings.map((saving, idx) => {
                const income = monthlyIncome[idx];
                return income > 0 ? ((saving / income) * 100).toFixed(1) : 0;
            });
            cashFlowChart.data.datasets[0].data = newCashFlowPercentages;
            cashFlowChart.update();

            updateSummaryCards();
        }
    </script>